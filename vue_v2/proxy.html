<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>渲染代理 | 雨碎江南</title>
    <meta name="description" content="lmh的前端学习笔记">
    <link rel="icon" href="/blog/pen.png">
  <link rel="manifest" href="/blog/manifest.json">
  <meta name="theme-color" content="#3eaf7c">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black">
  <link rel="apple-touch-icon" href="/blog/icons/apple-touch-icon-152x152.png">
  <link rel="mask-icon" href="/blog/icons/safari-pinned-tab.svg" color="#3eaf7c">
  <meta name="msapplication-TileImage" content="/icons/msapplication-icon-144x144.png">
  <meta name="msapplication-TileColor" content="#000000">
    
    <link rel="preload" href="/blog/assets/css/0.styles.48263c0b.css" as="style"><link rel="preload" href="/blog/assets/js/app.72bc0fac.js" as="script"><link rel="preload" href="/blog/assets/js/2.c5bb9098.js" as="script"><link rel="preload" href="/blog/assets/js/15.31b83f28.js" as="script"><link rel="prefetch" href="/blog/assets/js/10.a6345a3b.js"><link rel="prefetch" href="/blog/assets/js/11.1d6bcda9.js"><link rel="prefetch" href="/blog/assets/js/12.ccf5b6b4.js"><link rel="prefetch" href="/blog/assets/js/13.c823062d.js"><link rel="prefetch" href="/blog/assets/js/14.1e1e2752.js"><link rel="prefetch" href="/blog/assets/js/16.d2dee094.js"><link rel="prefetch" href="/blog/assets/js/17.ddcc8c79.js"><link rel="prefetch" href="/blog/assets/js/3.198e4c55.js"><link rel="prefetch" href="/blog/assets/js/4.8be81cf4.js"><link rel="prefetch" href="/blog/assets/js/5.822361f8.js"><link rel="prefetch" href="/blog/assets/js/6.3c9c8e22.js"><link rel="prefetch" href="/blog/assets/js/7.21cd4e7b.js"><link rel="prefetch" href="/blog/assets/js/8.c1ba0fe9.js"><link rel="prefetch" href="/blog/assets/js/9.8af815aa.js">
    <link rel="stylesheet" href="/blog/assets/css/0.styles.48263c0b.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/blog/" class="home-link router-link-active"><!----> <span class="site-name">雨碎江南</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/vue_v2/" class="nav-link router-link-active">Vue2.x</a></div> <a href="https://github.com/lmhcoding/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/blog/" class="nav-link">首页</a></div><div class="nav-item"><a href="/blog/vue_v2/" class="nav-link router-link-active">Vue2.x</a></div> <a href="https://github.com/lmhcoding/blog" target="_blank" rel="noopener noreferrer" class="repo-link">
    GitHub
    <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></nav>  <ul class="sidebar-links"><li><section class="sidebar-group depth-0"><p class="sidebar-heading open"><span>Vue2.x源码阅读</span> <!----></p> <ul class="sidebar-links sidebar-group-items"><li><a href="/blog/vue_v2/" class="sidebar-link">前言</a></li><li><a href="/blog/vue_v2/directory.html" class="sidebar-link">Vue项目目录设计</a></li><li><a href="/blog/vue_v2/build.html" class="sidebar-link">Vue 源码构建</a></li><li><a href="/blog/vue_v2/constructor.html" class="sidebar-link">Vue构造函数</a></li><li><a href="/blog/vue_v2/new_vue.html" class="sidebar-link">new Vue的背后</a></li><li><a href="/blog/vue_v2/mergeOptions.html" class="sidebar-link">选项合并（mergeOptions)</a></li><li><a href="/blog/vue_v2/strats.html" class="sidebar-link">选项合并策略</a></li><li><a href="/blog/vue_v2/component_merge.html" class="sidebar-link">子组件选项合并</a></li><li><a href="/blog/vue_v2/proxy.html" class="active sidebar-link">渲染代理</a></li><li><a href="/blog/vue_v2/init.html" class="sidebar-link">Vue初始化</a></li></ul></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="渲染代理"><a href="#渲染代理" class="header-anchor">#</a> 渲染代理</h1> <p>日常开发中，相信大家对下面图中的这个错误并不陌生：</p> <p><img src="/proxy_error.jpg" alt=""></p> <p>那么，Vue是怎么在渲染的过程中触发这样的警告呢？</p> <p>当Vue在挂载组件时，会执行<code>mountComponent</code>方法，该方法内部会执行如下代码，进行组件的挂载：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function-variable function">updateComponent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    vm<span class="token punctuation">.</span><span class="token function">_update</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span><span class="token function">_render</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> hydrating<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p><code>_update</code>内部会执行补丁算法将<code>_render</code>生成的<code>vdom</code>转换为真实dom。</p> <p><code>_render</code>内部最终会调用<code>$options.render</code>方法生成<code>vdom</code>。我们来看看它是怎么调用的：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">let</span> vnode
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token comment">// There's no need to maintain a stack becaues all render fns are called</span>
    <span class="token comment">// separately from one another. Nested component's render fns are called</span>
    <span class="token comment">// when parent component is patched.</span>
    currentRenderingInstance <span class="token operator">=</span> vm
    vnode <span class="token operator">=</span> <span class="token function">render</span><span class="token punctuation">.</span><span class="token function">call</span><span class="token punctuation">(</span>vm<span class="token punctuation">.</span>_renderProxy<span class="token punctuation">,</span> vm<span class="token punctuation">.</span>$createElement<span class="token punctuation">)</span>
<span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span> <span class="token operator">...</span> <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br></div></div><p><code>_render</code>在执行<code>$options.render</code>时会把<code>vm._renderProxy</code>作为它的上下文，<code>$options.render</code>内部访问this时，实际上访问的是<code>vm._renderProxy</code>。Vue正是通过<code>_renderProxy</code>在实例上做了一层拦截发出警告的，那么，<code>_renderProxy</code>究竟是是如何做拦截的呢？</p> <p>Vue初始化时，在执行完选项合并后会执行下面的代码：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code>    <span class="token comment">/* istanbul ignore else */</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span><span class="token constant">NODE_ENV</span> <span class="token operator">!==</span> <span class="token string">'production'</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 开发环境下设置渲染代理_renderProxy</span>
      <span class="token comment">// 用于拦截对实例属性的访问</span>
      <span class="token comment">// 检查渲染时使用的变量、函数是否是允许的全局属性/函数</span>
      <span class="token comment">// 检查渲染时是否的变量是否以$、_开头，并给出警告</span>
      <span class="token function">initProxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>_renderProxy <span class="token operator">=</span> vm
    <span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>在非生产环境下，会执行<code>initProxy(vm)</code>往Vue实例上添加<code>_renderProxy</code>属性，生产环境下，<code>_renderProxy</code>即为Vue实例。下面来看看<code>initProxy</code>的实现。</p> <p><code>core/instance/proxy.js</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function-variable function">initProxy</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token function">initProxy</span> <span class="token punctuation">(</span><span class="token parameter">vm</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>hasProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// determine which proxy handler to use</span>
      <span class="token keyword">const</span> options <span class="token operator">=</span> vm<span class="token punctuation">.</span>$options
      <span class="token comment">// vue-loader把模板编译成render函数，render函数符合严格模式，不会使用with，并且_withStripped为true</span>
      <span class="token comment">// 自写render函数，并将render._withStripped设置为true时使用getHandler</span>
      <span class="token comment">// 使用template选项编译成的render函数使用with，handlers为hasHandler</span>
      <span class="token keyword">const</span> handlers <span class="token operator">=</span> options<span class="token punctuation">.</span>render <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>render<span class="token punctuation">.</span>_withStripped
        <span class="token operator">?</span> getHandler
        <span class="token punctuation">:</span> hasHandler
      vm<span class="token punctuation">.</span>_renderProxy <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>vm<span class="token punctuation">,</span> handlers<span class="token punctuation">)</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
      vm<span class="token punctuation">.</span>_renderProxy <span class="token operator">=</span> vm
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br><span class="line-number">15</span><br></div></div><p>这段逻辑同样只有在非生产环境下才会执行，也就是说在生产环境下<code>initProxy</code>才会有定义，这也是在执行<code>initProxy</code>时要判断环境的原因。<code>initProxy</code>内部首先判断是否支持<code>proxy</code>API，若支持，则会在实例上添加一层代理拦截，并赋值给实例属性<code>_renderProxy</code>,否则，<code>_renderProxy</code>则为实例本身。</p> <p>当在非生产环境时，传入Proxy构造函数的handlers可能为getHandler或hasHandler。我们先来看看这两个handler的内容：</p> <p><code>hasHandler</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> hasHandler <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token function">has</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">const</span> has <span class="token operator">=</span> key <span class="token keyword">in</span> target
      <span class="token keyword">const</span> isAllowed <span class="token operator">=</span> <span class="token function">allowedGlobals</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span> <span class="token operator">||</span>
        <span class="token punctuation">(</span><span class="token keyword">typeof</span> key <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> key<span class="token punctuation">.</span><span class="token function">charAt</span><span class="token punctuation">(</span><span class="token number">0</span><span class="token punctuation">)</span> <span class="token operator">===</span> <span class="token string">'_'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> target<span class="token punctuation">.</span>$data<span class="token punctuation">)</span><span class="token punctuation">)</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>has <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>isAllowed<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> target<span class="token punctuation">.</span>$data<span class="token punctuation">)</span> <span class="token function">warnReservedPrefix</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token keyword">else</span> <span class="token function">warnNonPresent</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> has <span class="token operator">||</span> <span class="token operator">!</span>isAllowed
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br></div></div><p><code>hasHandler</code>拦截的是in操作符。根据MDN的描述：</p> <p><img src="/proxy_has.jpg" alt="">
has可以进行四种拦截：</p> <pre><code>- in 查询
- 继承属性查询
- with检查
- Reflect.has
</code></pre> <p>其中，has拦截可以进行with检查是重点，这个我们稍后会说到。</p> <p>has拦截内调用了三个函数，<code>allowedGlobals</code>、 <code>warnReservedPrefix</code>和<code>warnNonPresent</code>,我们先来看看这三个函数都做了什么。</p> <p><code>allowedGlobals</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> allowedGlobals <span class="token operator">=</span> <span class="token function">makeMap</span><span class="token punctuation">(</span>
    <span class="token string">'Infinity,undefined,NaN,isFinite,isNaN,'</span> <span class="token operator">+</span>
    <span class="token string">'parseFloat,parseInt,decodeURI,decodeURIComponent,encodeURI,encodeURIComponent,'</span> <span class="token operator">+</span>
    <span class="token string">'Math,Number,Date,Array,Object,Boolean,String,RegExp,Map,Set,JSON,Intl,'</span> <span class="token operator">+</span>
    <span class="token string">'require'</span> <span class="token comment">// for Webpack/Browserify</span>
<span class="token punctuation">)</span>`
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br></div></div><p><code>allowedGlobals</code>定义了可以模板里可以使用的全局对象、全局函数等。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// 对模板中使用了未定义的属性、函数做出警告</span>
<span class="token keyword">const</span> <span class="token function-variable function">warnNonPresent</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
<span class="token function">warn</span><span class="token punctuation">(</span>
    <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Property or method &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; is not defined on the instance but </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
    <span class="token string">'referenced during render. Make sure that this property is reactive, '</span> <span class="token operator">+</span>
    <span class="token string">'either in the data option, or for class-based components, by '</span> <span class="token operator">+</span>
    <span class="token string">'initializing the property. '</span> <span class="token operator">+</span>
    <span class="token string">'See: https://vuejs.org/v2/guide/reactivity.html#Declaring-Reactive-Properties.'</span><span class="token punctuation">,</span>
    target
<span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p><code>warnNonPresent</code>则是对在模板中使用了未定义的属性、函数做出警告。</p> <p><code>warnReservedPrefix</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token comment">// key 以 $、_开头不会被proxy在Vue实例中</span>
<span class="token comment">// data中的key已$、_作出警告时给出警告</span>
<span class="token keyword">const</span> <span class="token function-variable function">warnReservedPrefix</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token parameter">target<span class="token punctuation">,</span> key</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token function">warn</span><span class="token punctuation">(</span>
        <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Property &quot;</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; must be accessed with &quot;$data.</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">&quot; because </span><span class="token template-punctuation string">`</span></span> <span class="token operator">+</span>
        <span class="token string">'properties starting with &quot;$&quot; or &quot;_&quot; are not proxied in the Vue instance to '</span> <span class="token operator">+</span>
        <span class="token string">'prevent conflicts with Vue internals'</span> <span class="token operator">+</span>
        <span class="token string">'See: https://vuejs.org/v2/api/#data'</span><span class="token punctuation">,</span>
        target
    <span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br></div></div><p>由于data中以<code>$</code>或者<code>_</code>开头的属性并不会被代理到Vue实例上，所以在模板中访问这类属性时会调用<code>warnReservedPrefix</code>函数做出警告。</p> <p><code>hasHandler</code>会进行两种检查：</p> <pre><code>- has: 检查访问的属性是否在实例或者实例的原型链上(in 操作符)
- 判断是否是允许的全局访问的函数或对象，或者不在$data上的以 _ 开头的属性
</code></pre> <p>当这两种判断都不满足时：</p> <pre><code>- 如果属性在$data上，则执行 warnReservedPrefix 进行警告
- 否则说明属性为定义，执行 warnNonPresent
</code></pre> <p><code>getHandler</code></p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> getHandler <span class="token operator">=</span> <span class="token punctuation">{</span>
    <span class="token keyword">get</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> key <span class="token operator">===</span> <span class="token string">'string'</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span><span class="token punctuation">(</span>key <span class="token keyword">in</span> target<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span>key <span class="token keyword">in</span> target<span class="token punctuation">.</span>$data<span class="token punctuation">)</span> <span class="token function">warnReservedPrefix</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
        <span class="token keyword">else</span> <span class="token function">warnNonPresent</span><span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">return</span> target<span class="token punctuation">[</span>key<span class="token punctuation">]</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br></div></div><p><code>getHandler</code>拦截的是对象的属性读取操作，它可以拦截目标对象的一下操作：</p> <pre><code>1. 属性访问：foo.bar
2. 访问原型链上的属性
3. Reflect.get
</code></pre> <p>由于拦截的是对象的属性读取操作，所以，不需要进行<code>hasHandler</code>的<code>isAllowed</code>检查，只需要检查访问的属性是不是在Vue实例上，当访问的属性不在Vue实例上时,会执行<code>hasHandler</code>if判断内同样的逻辑。</p> <p>为甚么会有两种拦截呢？</p> <p>回到<code>initProxy</code>中，有这么一个判断：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">const</span> handlers <span class="token operator">=</span> options<span class="token punctuation">.</span>render <span class="token operator">&amp;&amp;</span> options<span class="token punctuation">.</span>render<span class="token punctuation">.</span>_withStripped
    <span class="token operator">?</span> getHandler
    <span class="token punctuation">:</span> hasHandler
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>当render函数的<code>_withStripped</code>属性为真时为<code>getHandler</code>，否则为<code>hasHandler</code></p> <p>那么什么时候render函数的<code>_withStripped</code>属性为真呢？</p> <p>其实，整个Vue源码，只有在一个地方能看到这个属性为真，那就是在<code>render-proxy.spec.js</code>测试文件中。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token function">it</span><span class="token punctuation">(</span><span class="token string">'should warn missing property in render fns without `with`'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> <span class="token function-variable function">render</span> <span class="token operator">=</span> <span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">h</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">h</span><span class="token punctuation">(</span><span class="token string">'div'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token keyword">this</span><span class="token punctuation">.</span>a<span class="token punctuation">]</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    render<span class="token punctuation">.</span>_withStripped <span class="token operator">=</span> <span class="token boolean">true</span>
    <span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    render
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">$mount</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
    <span class="token function">expect</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Property or method &quot;a&quot; is not defined</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toHaveBeenWarned</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br></div></div><p>从测试代码可以看出，<code>_withStripped</code>属性是为了区分render函数是否有<code>with</code>。那么什么时候render函数内会有with语句呢。</p> <p>我们知道，Vue有多个编译版本，带编译器的和只有运行时的，使用带编译器的版本时，Vue会把template字符串编译为render函数，使用只有运行时的版本配合Vue-loader也可以编译得到render函数，但这两种方式得到的渲染函数是不一样的。</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">new</span> <span class="token class-name">Vue</span><span class="token punctuation">(</span><span class="token punctuation">{</span>
    el<span class="token punctuation">:</span> <span class="token string">'#app'</span>
    template<span class="token punctuation">:</span> <span class="token string">'&lt;h1&gt;{{a}}&lt;/h1&gt;'</span><span class="token punctuation">,</span>
    data<span class="token punctuation">:</span> <span class="token punctuation">{</span>
        a<span class="token punctuation">:</span> <span class="token number">1</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>编译得到的render函数为：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">with</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">_c</span><span class="token punctuation">(</span><span class="token string">'h1'</span><span class="token punctuation">,</span> <span class="token punctuation">[</span><span class="token function">_v</span><span class="token punctuation">(</span><span class="token function">_s</span><span class="token punctuation">(</span>a<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">]</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><p>而由于编译结果带有with语句，所以使用的是<code>has</code>拦截。</p> <p>而使用Vue-loader时，编译出来的render函数是符合严格模式的不带with语句的：</p> <div class="language-html line-numbers-mode"><pre class="language-html"><code><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>template</span><span class="token punctuation">&gt;</span></span>
    <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>h1</span><span class="token punctuation">&gt;</span></span>{{a}}<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>h1</span><span class="token punctuation">&gt;</span></span>
<span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>template</span><span class="token punctuation">&gt;</span></span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br></div></div><div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">export</span> <span class="token keyword">default</span> <span class="token punctuation">{</span>
    <span class="token function">data</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">return</span> <span class="token punctuation">{</span>
            a： <span class="token number">1</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br></div></div><p>编译得到的render函数为：</p> <p><img src="/render.jpg" alt="">
可以看到模板内的变量都是通过属性访问操作得到的，同时，编译后的render函数，Vue-loader会为其设置<code>_withStripped</code>为true，此时使用的是get拦截。</p> <p>当我们手写render函数而没有设置<code>_withStripped</code>为true时，虽然传入Proxy的是<code>hasHandler</code>，但是，render函数内使用的是直接的属性访问，所以触发不了has拦截，此时，如果我们使用了未经定义的属性是得不到任何警告的。</p> <p><code>core/instance/proxy.js</code>内还对Vue.config.keyCodes进行了代理拦截：</p> <div class="language-javascript line-numbers-mode"><pre class="language-javascript"><code><span class="token keyword">if</span> <span class="token punctuation">(</span>hasProxy<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">const</span> isBuiltInModifier <span class="token operator">=</span> <span class="token function">makeMap</span><span class="token punctuation">(</span><span class="token string">'stop,prevent,self,ctrl,shift,alt,meta,exact'</span><span class="token punctuation">)</span>
    config<span class="token punctuation">.</span>keyCodes <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Proxy</span><span class="token punctuation">(</span>config<span class="token punctuation">.</span>keyCodes<span class="token punctuation">,</span> <span class="token punctuation">{</span>
      <span class="token keyword">set</span> <span class="token punctuation">(</span>target<span class="token punctuation">,</span> key<span class="token punctuation">,</span> value<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isBuiltInModifier</span><span class="token punctuation">(</span>key<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">warn</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">Avoid overwriting built-in modifier in config.keyCodes: .</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>key<span class="token interpolation-punctuation punctuation">}</span></span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span>
          <span class="token keyword">return</span> <span class="token boolean">false</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          target<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> value
          <span class="token keyword">return</span> <span class="token boolean">true</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre> <div class="line-numbers-wrapper"><span class="line-number">1</span><br><span class="line-number">2</span><br><span class="line-number">3</span><br><span class="line-number">4</span><br><span class="line-number">5</span><br><span class="line-number">6</span><br><span class="line-number">7</span><br><span class="line-number">8</span><br><span class="line-number">9</span><br><span class="line-number">10</span><br><span class="line-number">11</span><br><span class="line-number">12</span><br><span class="line-number">13</span><br><span class="line-number">14</span><br></div></div><p>这段代码很简单，就是在我们尝试覆盖内置的修饰符时做出警告，防止开发者自定义键位别名时覆盖了内置的事件修饰符。</p></div> <footer class="page-edit"><div class="edit-link"><a href="https://github.com/lmhcoding/blog/edit/master/docs/vue_v2/proxy.md" target="_blank" rel="noopener noreferrer">在 GitHub 上编辑此页</a> <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></div> <div class="last-updated"><span class="prefix">上次更新:</span> <span class="time">3/14/2020, 2:37:03 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/blog/vue_v2/component_merge.html" class="prev">子组件选项合并</a></span> <span class="next"><a href="/blog/vue_v2/init.html">Vue初始化</a>
      →
    </span></p></div> </main></div><div class="global-ui"><!----></div></div>
    <script src="/blog/assets/js/app.72bc0fac.js" defer></script><script src="/blog/assets/js/2.c5bb9098.js" defer></script><script src="/blog/assets/js/15.31b83f28.js" defer></script>
  </body>
</html>
